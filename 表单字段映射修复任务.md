# Context
Filename: 表单字段映射修复任务.md
Created On: 2024-01-15
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
修复FlowableUtils.java中getSummaryAll方法和buildDisplayValue方法的表单字段映射问题。当前代码在处理复杂的嵌套表单数据（如子表单、表格表单）时，无法正确将字段key转换为对应的标题，导致显示效果不佳。

用户反馈的具体问题：
- 表单数据中包含复杂的嵌套结构（JSON对象和数组）
- 子表单中的字段key（如Fc37mauycpze155c、numberField_m4mikq2z等）没有被正确转换为标题
- 显示结果中仍然显示原始的字段key而不是用户友好的标题

# Project Overview
项目基于芋道源码的BPM流程管理系统，使用Flowable引擎处理工作流。FlowableUtils是核心工具类，负责处理流程实例的表单数据展示和摘要生成。

---
*以下部分由AI在协议执行过程中维护*
---

# Analysis (RESEARCH模式填充)
## 代码调查结果

### 关键文件和方法：
1. **FlowableUtils.java** - 核心工具类
   - `getSummaryAll()`: 获取流程实例的所有摘要字段
   - `buildDisplayValue()`: 构建展示用的表单值
   - `parseFormFieldsMap()`: 解析表单字段配置
   - `collectFieldTitles()`: 收集字段标题映射

### 关键依赖和约束：
1. **BpmFormFieldVO** - 表单字段对象，包含type、field、title属性
2. **BpmProcessDefinitionInfoDO** - 流程定义信息，包含表单配置
3. **表单数据结构** - 支持嵌套的Map和List结构

### 问题根源分析：
从用户提供的日志输出可以看出：
- value: 包含复杂嵌套结构的JSON数据，如"视频剪辑"表单
- formFieldsMap: 包含所有已解析的字段配置映射
- fieldKey: 当前处理的字段key

**核心问题**：
1. `buildDisplayValue`方法在处理Map类型数据时，尝试从formFieldsMap中查找子字段配置
2. 但子表单中的字段（如Fc37mauycpze155c）可能不在顶层formFieldsMap中
3. 导致找不到对应的BpmFormFieldVO配置，无法获取正确的标题
4. 最终显示原始字段key而不是用户友好的标题

### 技术难点：
1. 表单配置的嵌套结构解析
2. 动态字段key与静态配置的匹配
3. 不同类型表单组件的统一处理
4. 保持向后兼容性

# Proposed Solution (INNOVATE模式填充)
## 解决方案评估

### 方案一：增强 buildDisplayValue 方法的字段匹配逻辑
**优点**：改动最小，风险最低，保持现有API接口不变
**缺点**：可能增加方法复杂度，智能匹配可能存在歧义

### 方案二：完善 parseFormFieldsMap 和 collectFieldTitles 方方法
**优点**：从根源解决问题，提升表单解析的完整性，对现有代码影响相对较小
**缺点**：需要深入理解表单配置格式，可能影响解析性能

### 方案三：引入字段配置缓存机制
**优点**：性能优化明显，支持复杂场景，扩展性好
**缺点**：增加系统复杂度，内存使用增加，缓存一致性问题

### 方案四：重构表单数据处理架构
**优点**：长远解决方案，架构更清晰，可维护性强
**缺点**：改动量大，风险高，开发周期长

## 推荐方案
采用**方案二为主 + 方案一为辅**的混合解决方案：

1. **主要改进**: 增强 `collectFieldTitles` 方法，确保能够正确解析和收集所有嵌套字段的配置
2. **辅助优化**: 优化 `buildDisplayValue` 方法，增加更智能的字段匹配逻辑
3. **兼容性保证**: 保持向后兼容性，确保现有功能不受影响

### 核心技术点：
- 深度递归解析表单配置中的嵌套结构
- 支持表格表单（tableForm）类型的字段解析
- 改进字段匹配算法，支持动态生成字段的识别
- 移除调试日志输出，提升代码质量

# Implementation Plan (PLAN模式生成)
## 详细技术规格

### 文件修改清单：
**目标文件**: `yudao-module-bpm/yudao-module-bpm-biz/src/main/java/cn/iocoder/yudao/module/bpm/framework/flowable/core/util/FlowableUtils.java`

### 修改详细规格：

#### 修改1：增强 collectFieldTitles 方法
- **位置**: 第540-555行
- **目的**: 支持表格表单和复杂嵌套结构的字段解析
- **新增功能**:
  - 解析 `children` 属性（子表单字段）
  - 解析 `columns` 属性（表格列配置）
  - 解析 `list` 属性（数组字段）
  - 解析 `__config__` 属性（表单设计器配置）
- **技术实现**: 递归遍历所有可能的嵌套属性

#### 修改2：优化 buildDisplayValue 方法  
- **位置**: 第460-503行
- **目的**: 改进字段匹配算法，增加容错能力
- **新增功能**:
  - 当精确匹配失败时，尝试模糊匹配
  - 支持字段名称的部分匹配和近似匹配
  - 增加上下文推断逻辑
- **技术实现**: 在现有逻辑基础上增加回退匹配机制

#### 修改3：清理调试代码
- **位置**: getSummaryAll方法第435-441行
- **目的**: 移除调试日志，提升代码质量
- **修改内容**: 删除所有 `System.out.println` 语句

#### 修改4：错误处理增强
- **目的**: 增加空值检查和异常处理
- **技术实现**: 在关键位置添加防护性编程逻辑

### 代码质量要求：
- 保持所有方法签名不变
- 添加必要的注释说明新功能
- 确保线程安全（如果需要）
- 保持现有的性能水平

Implementation Checklist:
1. 备份原始FlowableUtils.java文件
2. 增强collectFieldTitles方法，支持嵌套字段解析
3. 添加对children、columns、list等属性的递归处理
4. 优化buildDisplayValue方法的字段匹配逻辑
5. 实现模糊匹配和回退机制
6. 移除getSummaryAll方法中的调试日志
7. 添加必要的错误处理和边界检查
8. 验证修改后的代码编译通过
9. 进行基本功能测试
10. 确认修复效果符合预期 